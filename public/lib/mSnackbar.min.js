$(function () {
  var snackbars = {};
  const css = ``;
  $('body').append(css)
    .append('<div id="mSnackbarContainer"></div>');
  var snackbarContainer = $('#mSnackbarContainer');
  const mSnackbarIterator = function () {
    let value = 0;
    return function () {
      return value++;
    };
  }();

  class Snackbar {
    constructor({
      text,
      lifeSpan,
      actions,
      hasCloseButton
    } = {}) {
      this.text = text;
      this.lifeSpan = lifeSpan;
      this.hasCloseButton = false;
      if (hasCloseButton) {
        this.hasCloseButton = hasCloseButton;
      }
      if (!lifeSpan) {
        this.lifeSpan = 3000;
      }
      //todo add optional close button
      this.actions = actions;
      this.id = 'mSnackbar' + mSnackbarIterator();

      snackbarContainer.append(`<span id="${this.id}" class="snackbar-wrapper"><div class="mSnackbar">${text}</div></span>`);
      this.$ref = $('#' + this.id);
      var tempCloseSnackbar = this.closeSnackbar;
      if (this.lifeSpan !== Infinity) {
        setTimeout(() => this.closeSnackbar(), this.lifeSpan);
      }
    }

    closeSnackbar() {
      if (Object.keys(snackbars).length > 1) {
        this.$ref.animate({
          opacity: 0
        }, 200, () => {
          this.$ref.animate({
            height: 0
          }, 200, () => {
            snackbarContainer.addClass('no-transition');
            snackbarContainer.css('bottom', -snackbarContainer.height());
            snackbarContainer.css('transform', `translateY(${-snackbarContainer.height()}px)`);
            snackbarContainer[0].offsetHeight; //this does magic things that allows the transition to happen
            snackbarContainer.removeClass('no-transition');
            this.$ref.remove();
            delete snackbars[this.id];
          });
        });
      } else {
        snackbarContainer.css('bottom', -snackbarContainer.height());
        snackbarContainer.css('transform', `translateY(0px)`);
        setTimeout(() => this.$ref.remove(), 500);
        delete snackbars[this.id];
      }
    }
  }
  jQuery.mSnackbar = function () {
    return function ({
      text,
      lifeSpan,
      actions
    } = {}) {

      var newSnackbar = new Snackbar({
        lifeSpan: lifeSpan,
        text: text,
        actions: actions
      });
      snackbars[newSnackbar.id] = newSnackbar;
      snackbarContainer.css('bottom', -snackbarContainer.height());
      snackbarContainer.css('transform', `translateY(${-snackbarContainer.height()}px)`);
      // .css('transition', 'all 0.5s');
      return snackbars[newSnackbar.id];
    };
  }();
});
//todo make it support multiple popups
//todo add a toggleable close button